!function(){"use strict";if(window.ChatWidgetLoaded)return;window.ChatWidgetLoaded=!0;const n=window.ChatWidgetConfig||{welcomeMessage:"Hello! Welcome to our chat.",subtitle:"I am here to help.",actionButtons:[{text:"Get Started",action:"get_started"},{text:"I have a question",action:"question"},{text:"Other",action:"other"}],agentName:"Sarah",agentAvatar:"",primaryColor:"#0891b2",showAgent:!0,companyName:"The Grout Medic",companyTagline:"Chatting with Sarah",recordingDisclaimer:"This transcript will be recorded by The Grout Medic and its affiliates.",termsOfUseUrl:"#",privacyPolicyUrl:"#",poweredBy:"Explained Consulting",poweredByUrl:"https://www.explained.consulting",webhookUrl:null,chatInputKey:"chatInput",chatSessionKey:"sessionId",conversationTimeoutMinutes:20,metadata:{},onMessageSend:null,onMessageReceive:null,onError:null};function e(){return"session_"+Date.now()+"_"+Math.random().toString(36).substr(2,9)}function t(){let n=localStorage.getItem("n8n_chat_session_id");return n||(n=e(),localStorage.setItem("n8n_chat_session_id",n)),n}function a(n,e,t=Date.now()){const a=o();a.push({message:n,sender:e,timestamp:t}),localStorage.setItem("n8n_chat_messages",JSON.stringify(a)),localStorage.setItem("n8n_chat_last_activity",Date.now().toString())}function o(){const n=localStorage.getItem("n8n_chat_messages");return n?JSON.parse(n):[]}function i(){localStorage.removeItem("n8n_chat_messages"),localStorage.removeItem("n8n_chat_last_activity")}function r(){if(!n.conversationTimeoutMinutes||n.conversationTimeoutMinutes<=0)return!1;const e=function(){const n=localStorage.getItem("n8n_chat_last_activity");return n?parseInt(n):null}();if(!e)return!1;const t=60*n.conversationTimeoutMinutes*1e3;return Date.now()-e>t}const s=`\n    #chat-widget-container {\n      position: fixed;\n      bottom: 20px;\n      right: 20px;\n      z-index: 9999;\n      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;\n    }\n    \n    #chat-widget-button {\n      width: 60px;\n      height: 60px;\n      border-radius: 50%;\n      background: ${n.primaryColor};\n      border: none;\n      cursor: pointer;\n      box-shadow: 0 4px 12px rgba(0,0,0,0.15);\n      display: flex;\n      align-items: center;\n      justify-content: center;\n      transition: transform 0.3s ease;\n      position: relative;\n    }\n    \n    #chat-widget-button:hover {\n      transform: scale(1.1);\n    }\n    \n    #chat-widget-button svg {\n      width: 30px;\n      height: 30px;\n      fill: white;\n    }\n    \n    #chat-widget-window {\n      position: absolute;\n      bottom: 80px;\n      right: 0;\n      width: 450px;\n      height: 600px;\n      background: white;\n      border-radius: 16px;\n      box-shadow: 0 5px 40px rgba(0,0,0,0.16);\n      display: none;\n      flex-direction: column;\n      overflow: hidden;\n    }\n    \n    #chat-widget-window.open {\n      display: flex;\n      animation: slideUp 0.3s ease;\n    }\n    \n    @keyframes slideUp {\n      from {\n        opacity: 0;\n        transform: translateY(20px);\n      }\n      to {\n        opacity: 1;\n        transform: translateY(0);\n      }\n    }\n    \n    #chat-widget-header {\n      background: ${n.primaryColor};\n      color: white;\n      padding: 16px;\n      display: flex;\n      justify-content: space-between;\n      align-items: center;\n      position: relative;\n    }\n    \n    .header-left {\n      display: flex;\n      align-items: center;\n      gap: 12px;\n      flex: 1;\n    }\n    \n    .header-agent-avatar {\n      width: 40px;\n      height: 40px;\n      border-radius: 50%;\n      border: 2px solid rgba(255,255,255,0.3);\n      overflow: hidden;\n    }\n    \n    .header-agent-avatar img {\n      width: 100%;\n      height: 100%;\n      object-fit: cover;\n    }\n    \n    .header-agent-info h3 {\n      margin: 0;\n      font-size: 14px;\n      font-weight: 600;\n      line-height: 1.3;\n    }\n    \n    .header-agent-info p {\n      margin: 0;\n      font-size: 11px;\n      opacity: 0.9;\n      line-height: 1.3;\n      margin-top: 2px;\n    }\n    \n    \n    .header-right {\n      display: flex;\n      align-items: center;\n      gap: 8px;\n    }\n    \n    \n    #chat-widget-close,\n    #chat-widget-clear {\n      background: none;\n      border: none;\n      color: white;\n      cursor: pointer;\n      font-size: 18px;\n      padding: 0;\n      width: 24px;\n      height: 24px;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n    }\n    \n    #chat-widget-clear {\n      font-size: 14px;\n      margin-right: 4px;\n    }\n    \n    #chat-widget-messages {\n      flex: 1;\n      overflow-y: auto;\n      padding: 20px;\n      background: #f7f7f7;\n    }\n    \n    #chat-welcome-screen {\n      display: flex;\n      flex-direction: column;\n      align-items: center;\n      text-align: center;\n      padding: 30px 20px;\n    }\n    \n    #chat-welcome-screen h2 {\n      margin: 0 0 8px 0;\n      font-size: 18px;\n      color: #333;\n      font-weight: 600;\n    }\n    \n    #chat-welcome-screen p {\n      margin: 0 0 24px 0;\n      font-size: 13px;\n      color: #666;\n    }\n    \n    .chat-action-button {\n      width: 100%;\n      padding: 12px 18px;\n      margin-bottom: 10px;\n      border: 2px solid ${n.primaryColor};\n      background: white;\n      color: ${n.primaryColor};\n      border-radius: 25px;\n      font-size: 13px;\n      font-weight: 500;\n      cursor: pointer;\n      transition: all 0.2s ease;\n    }\n    \n    .chat-action-button:hover {\n      background: ${n.primaryColor};\n      color: white;\n    }\n    \n    .chat-action-button.primary {\n      background: ${n.primaryColor};\n      color: white;\n    }\n    \n    .chat-action-button.primary:hover {\n      opacity: 0.9;\n      transform: translateY(-1px);\n    }\n    \n    .chat-message {\n      margin-bottom: 16px;\n      display: flex;\n      align-items: flex-end;\n      gap: 8px;\n    }\n    \n    .chat-message.bot {\n      flex-direction: row;\n    }\n    \n    .chat-message.user {\n      flex-direction: row-reverse;\n    }\n    \n    .message-avatar {\n      width: 32px;\n      height: 32px;\n      border-radius: 50%;\n      flex-shrink: 0;\n      overflow: hidden;\n      border: 2px solid #fff;\n      box-shadow: 0 1px 3px rgba(0,0,0,0.1);\n    }\n    \n    .message-avatar img {\n      width: 100%;\n      height: 100%;\n      object-fit: cover;\n    }\n    \n    .chat-message.user .message-avatar {\n      display: none;\n    }\n    \n    .chat-message-content {\n      max-width: 75%;\n      padding: 10px 14px;\n      border-radius: 18px;\n      word-wrap: break-word;\n      white-space: pre-wrap;\n      position: relative;\n      box-shadow: 0 1px 2px rgba(0,0,0,0.1);\n      line-height: 1.3;\n      font-size: 13px;\n    }\n    \n    .chat-message-content strong {\n      font-weight: 600;\n    }\n    \n    .chat-message-content em {\n      font-style: italic;\n    }\n    \n    .chat-message-content div {\n      margin: 4px 0;\n    }\n    \n    .chat-message.bot .chat-message-content {\n      background: #ffffff;\n      color: #333;\n      border: 1px solid #e1e5e9;\n    }\n    \n    .chat-message.user .chat-message-content {\n      background: ${n.primaryColor};\n      color: white;\n    }\n    \n    /* Speech bubble tails */\n    .chat-message.bot .chat-message-content::before {\n      content: '';\n      position: absolute;\n      left: -9px;\n      bottom: 8px;\n      width: 0;\n      height: 0;\n      border-top: 8px solid transparent;\n      border-bottom: 8px solid transparent;\n      border-right: 9px solid #e1e5e9;\n      z-index: 1;\n    }\n    \n    .chat-message.bot .chat-message-content::after {\n      content: '';\n      position: absolute;\n      left: -8px;\n      bottom: 8px;\n      width: 0;\n      height: 0;\n      border-top: 8px solid transparent;\n      border-bottom: 8px solid transparent;\n      border-right: 8px solid #ffffff;\n      z-index: 2;\n    }\n    \n    .chat-message.user .chat-message-content::after {\n      content: '';\n      position: absolute;\n      right: -8px;\n      bottom: 8px;\n      width: 0;\n      height: 0;\n      border-top: 8px solid transparent;\n      border-bottom: 8px solid transparent;\n      border-left: 8px solid ${n.primaryColor};\n    }\n\n    .chat-message.typing {\n      align-items: flex-start;\n    }\n\n    .typing-indicator {\n      background: white;\n      padding: 10px 14px;\n      border-radius: 12px;\n      display: flex;\n      gap: 4px;\n    }\n\n    .typing-indicator span {\n      width: 8px;\n      height: 8px;\n      border-radius: 50%;\n      background: #999;\n      animation: typing 1.4s infinite;\n    }\n\n    .typing-indicator span:nth-child(2) {\n      animation-delay: 0.2s;\n    }\n\n    .typing-indicator span:nth-child(3) {\n      animation-delay: 0.4s;\n    }\n\n    @keyframes typing {\n      0%, 60%, 100% {\n        transform: translateY(0);\n      }\n      30% {\n        transform: translateY(-10px);\n      }\n    }\n    \n    #chat-widget-input-container {\n      padding: 16px;\n      background: white;\n      border-top: 1px solid #eee;\n      display: flex;\n      gap: 8px;\n    }\n    \n    #chat-widget-input {\n      flex: 1;\n      border: 1px solid #ddd;\n      border-radius: 20px;\n      padding: 8px 14px;\n      font-size: 13px;\n      outline: none;\n      resize: none;\n      min-height: 20px;\n      max-height: 120px;\n      font-family: inherit;\n      line-height: 1.3;\n    }\n    \n    #chat-widget-input:focus {\n      border-color: ${n.primaryColor};\n    }\n    \n    #chat-widget-send {\n      background: ${n.primaryColor};\n      color: white;\n      border: none;\n      border-radius: 50%;\n      width: 40px;\n      height: 40px;\n      cursor: pointer;\n      display: flex;\n      align-items: center;\n      justify-content: center;\n    }\n\n    #chat-widget-send:disabled {\n      opacity: 0.5;\n      cursor: not-allowed;\n    }\n    \n    #chat-widget-send:hover:not(:disabled) {\n      opacity: 0.9;\n    }\n    \n    #chat-widget-send svg {\n      width: 20px;\n      height: 20px;\n      fill: white;\n    }\n\n    #chat-agent-avatar {\n      position: absolute;\n      bottom: -10px;\n      right: -10px;\n      width: 70px;\n      height: 70px;\n      border-radius: 50%;\n      border: 3px solid white;\n      box-shadow: 0 2px 8px rgba(0,0,0,0.15);\n      overflow: hidden;\n      display: ${n.showAgent?"block":"none"};\n    }\n\n    #chat-agent-avatar img {\n      width: 100%;\n      height: 100%;\n      object-fit: cover;\n    }\n\n    .agent-status {\n      position: absolute;\n      bottom: 5px;\n      right: 5px;\n      width: 16px;\n      height: 16px;\n      background: #22c55e;\n      border: 2px solid white;\n      border-radius: 50%;\n    }\n\n    .chat-conversation-view {\n      display: none;\n    }\n\n    .chat-conversation-view.active {\n      display: block;\n    }\n\n    /* Legal Disclaimer Banner */\n    .legal-disclaimer {\n      background: #f8f9fa;\n      border-bottom: 1px solid #e9ecef;\n      padding: 10px 14px;\n      font-size: 10px;\n      line-height: 1.3;\n      color: #6c757d;\n    }\n\n    .legal-disclaimer a {\n      color: #007bff;\n      text-decoration: underline;\n    }\n\n    .legal-disclaimer a:hover {\n      color: #0056b3;\n    }\n\n    /* Footer */\n    .chat-widget-footer {\n      background: #f8f9fa;\n      border-top: 1px solid #e9ecef;\n      padding: 6px 14px;\n      text-align: center;\n      font-size: 9px;\n      color: #6c757d;\n    }\n\n    .chat-widget-footer .powered-by {\n      color: #6f42c1;\n      font-weight: 500;\n      text-decoration: none;\n    }\n    \n    .chat-widget-footer .powered-by:hover {\n      text-decoration: underline;\n    }\n\n    /* Mobile responsiveness */\n    @media (max-width: 480px) {\n      #chat-widget-container {\n        bottom: 10px;\n        right: 10px;\n        left: 10px;\n      }\n      \n      #chat-widget-button {\n        width: 50px;\n        height: 50px;\n        bottom: 10px;\n        right: 10px;\n      }\n      \n      #chat-widget-button svg {\n        width: 24px;\n        height: 24px;\n      }\n      \n      #chat-widget-window {\n        width: 100%;\n        height: 80vh;\n        max-height: 600px;\n        bottom: 70px;\n        right: 0;\n        left: 0;\n        border-radius: 16px 16px 0 0;\n      }\n      \n      #chat-widget-messages {\n        padding: 15px;\n      }\n      \n      .chat-message-content {\n        max-width: 85%;\n        font-size: 14px;\n      }\n      \n      .message-avatar {\n        width: 28px;\n        height: 28px;\n      }\n      \n      .header-agent-avatar {\n        width: 36px;\n        height: 36px;\n      }\n      \n      .header-agent-info h3 {\n        font-size: 13px;\n        line-height: 1.2;\n      }\n      \n      .header-agent-info p {\n        font-size: 10px;\n        line-height: 1.2;\n        margin-top: 1px;\n      }\n      \n      \n      .legal-disclaimer {\n        padding: 8px 10px;\n        font-size: 9px;\n      }\n      \n      .chat-widget-footer {\n        padding: 5px 10px;\n        font-size: 8px;\n      }\n      \n      #chat-widget-input-container {\n        padding: 12px;\n      }\n      \n      #chat-widget-input {\n        font-size: 16px; /* Prevents zoom on iOS */\n        border-radius: 16px;\n      }\n      \n      #chat-agent-avatar {\n        width: 60px;\n        height: 60px;\n        bottom: -8px;\n        right: -8px;\n      }\n      \n      .chat-action-button {\n        padding: 14px 18px;\n        font-size: 14px;\n      }\n      \n      #chat-welcome-screen {\n        padding: 18px 12px;\n      }\n      \n      #chat-welcome-screen h2 {\n        font-size: 16px;\n      }\n      \n      #chat-welcome-screen p {\n        font-size: 12px;\n      }\n    }\n\n    @media (max-width: 320px) {\n      #chat-widget-window {\n        height: 85vh;\n      }\n      \n      .chat-message-content {\n        max-width: 90%;\n      }\n    }\n  `,d=document.createElement("style");d.textContent=s,document.head.appendChild(d);const c=n.actionButtons.map((n,e)=>`<button class="chat-action-button ${0===e?"primary":""}" data-action="${n.action}">${n.text}</button>`).join(""),l=`\n    <div id="chat-widget-container">\n      <div id="chat-widget-window">\n        <div id="chat-widget-header">\n          <div class="header-left">\n            <div class="header-agent-avatar">\n              <img src="${n.agentAvatar}" alt="${n.agentName}" />\n            </div>\n            <div class="header-agent-info">\n              <h3>${n.companyName}</h3>\n              <p>${n.companyTagline}</p>\n            </div>\n          </div>\n          <div class="header-right">\n            <button id="chat-widget-clear" title="Clear conversation">🔄</button>\n            <button id="chat-widget-close">&times;</button>\n          </div>\n        </div>\n        <div class="legal-disclaimer">\n          ${(n.recordingDisclaimer||"").replace(/Terms of Use/g,`<a href="${n.termsOfUseUrl}" target="_blank">Terms of Use</a>`).replace(/Privacy Policy/g,`<a href="${n.privacyPolicyUrl}" target="_blank">Privacy Policy</a>`)}\n        </div>\n        <div id="chat-widget-messages">\n          <div id="chat-welcome-screen">\n            <h2>${n.welcomeMessage}</h2>\n            <p>${n.subtitle}</p>\n            ${c}\n          </div>\n          <div class="chat-conversation-view"></div>\n        </div>\n        <div id="chat-widget-input-container">\n          <textarea id="chat-widget-input" placeholder="Type a message..." rows="1"></textarea>\n          <button id="chat-widget-send">\n            <svg viewBox="0 0 24 24">\n              <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>\n            </svg>\n          </button>\n        </div>\n        <div class="chat-widget-footer">\n          Powered by <a href="${n.poweredByUrl||"https://www.explained.consulting"}" target="_blank" class="powered-by">${n.poweredBy||"Expained Consulting"}</a>\n        </div>\n      </div>\n      <button id="chat-widget-button">\n        <svg viewBox="0 0 24 24">\n          <path d="M20 2H4c-1.1 0-2 .9-2 2v18l4-4h14c1.1 0 2-.9 2-2V4c0-1.1-.9-2-2-2z"/>\n        </svg>\n        ${n.showAgent?`\n          <div id="chat-agent-avatar">\n            <img src="${n.agentAvatar}" alt="${n.agentName}" />\n            <div class="agent-status"></div>\n          </div>\n        `:""}\n      </button>\n    </div>\n  `;if(document.addEventListener("DOMContentLoaded",function(){const s=document.createElement("div");s.innerHTML=l,document.body.appendChild(s);const d=document.getElementById("chat-widget-button"),c=document.getElementById("chat-widget-window"),p=document.getElementById("chat-widget-close"),g=document.getElementById("chat-widget-clear"),h=document.getElementById("chat-widget-input"),m=document.getElementById("chat-widget-send"),x=document.getElementById("chat-welcome-screen"),u=document.querySelector(".chat-conversation-view"),f=document.querySelectorAll(".chat-action-button");let w=!1;function b(n,e){w=!0,x.style.display="none",u.classList.add("active"),k(n,"user"),v(n,e)}async function v(e,a){const o=function(){const n=document.createElement("div");return n.className="chat-message typing",n.innerHTML='<div class="typing-indicator"><span></span><span></span><span></span></div>',u.appendChild(n),u.parentElement.scrollTop=u.parentElement.scrollHeight,n}();if(n.onMessageSend&&"function"==typeof n.onMessageSend&&n.onMessageSend(e,a),!n.webhookUrl)return y(o),void k("Chat webhook URL is not configured. Please set webhookUrl in ChatWidgetConfig.","bot");const i={action:a||"sendMessage",[n.chatSessionKey]:t(),[n.chatInputKey]:e,...n.metadata};try{const e=await fetch(n.webhookUrl,{method:"POST",headers:{"Content-Type":"application/json",Accept:"application/json"},body:JSON.stringify(i)});if(!e.ok)throw new Error(`HTTP error! status: ${e.status}`);const t=await e.json();y(o);k(t.output||t.response||t.message||t.text||t.data&&t.data.output||"Sorry, I did not understand that.","bot"),n.onMessageReceive&&"function"==typeof n.onMessageReceive&&n.onMessageReceive(t)}catch(e){console.error("Chat widget error:",e),y(o),n.onError&&"function"==typeof n.onError&&n.onError(e),k("Sorry, I'm having trouble connecting. Please try again later.","bot")}}function y(n){n&&n.parentNode&&n.parentNode.removeChild(n)}function k(e,t,o=!0){const i=document.createElement("div");i.className="chat-message "+t;let r="";"bot"===t&&n.showAgent&&(r=`<div class="message-avatar"><img src="${n.agentAvatar}" alt="${n.agentName}" /></div>`),i.innerHTML=`\n        ${r}\n        <div class="chat-message-content">${function(n){const e=document.createElement("div");e.textContent=n;let t=e.innerHTML;return t=t.replace(/\*\*(.*?)\*\*/g,"<strong>$1</strong>"),t=t.replace(/__(.*?)__/g,"<strong>$1</strong>"),t=t.replace(/\*(.*?)\*/g,"<em>$1</em>"),t=t.replace(/_(.*?)_/g,"<em>$1</em>"),t=t.replace(/\n/g,"<br>"),t=t.replace(/^(\d+)\.\s+(.+)$/gm,'<div style="margin-left: 20px; margin-bottom: 4px;"><strong>$1.</strong> $2</div>'),t=t.replace(/^[\-\*]\s+(.+)$/gm,'<div style="margin-left: 20px; margin-bottom: 4px;">• $1</div>'),t}(e)}</div>\n      `,u.appendChild(i),u.parentElement.scrollTop=u.parentElement.scrollHeight,o&&a(e,t)}async function E(){const n=h.value.trim();n&&(h.disabled=!0,m.disabled=!0,w?(k(n,"user"),await v(n,"sendMessage")):b(n,"sendMessage"),h.value="",h.disabled=!1,m.disabled=!1,h.focus())}d.addEventListener("click",function(){if(c.classList.toggle("open"),c.classList.contains("open")){h.focus();const n=document.getElementById("chat-agent-avatar");n&&(n.style.display="none"),setTimeout(()=>{u.parentElement.scrollTop=u.parentElement.scrollHeight},100)}else{const n=document.getElementById("chat-agent-avatar");n&&(n.style.display="block")}}),p.addEventListener("click",function(){c.classList.remove("open");const n=document.getElementById("chat-agent-avatar");n&&(n.style.display="block")}),g.addEventListener("click",function(){if(confirm("Clear conversation history? This cannot be undone.")){i();const n=e();localStorage.setItem("n8n_chat_session_id",n),w=!1,x.style.display="block",u.classList.remove("active"),u.innerHTML="",h.focus(),console.log("Chat widget: Conversation manually cleared - new session ID generated")}}),f.forEach(function(n){n.addEventListener("click",function(){const e=n.getAttribute("data-action");b(n.textContent,e)})}),w=function(){if(function(){if(r()){i();const n=e();return localStorage.setItem("n8n_chat_session_id",n),console.log("Chat widget: Conversation expired - new session ID generated"),!0}return!1}())return console.log("Chat widget: Conversation expired and cleared"),!1;const n=o();return n.length>0&&(x.style.display="none",u.classList.add("active"),n.forEach(n=>{k(n.message,n.sender,!1)}),setTimeout(()=>{u.parentElement.scrollTop=u.parentElement.scrollHeight},100),!0)}(),m.addEventListener("click",E),h.addEventListener("keydown",function(n){"Enter"!==n.key||n.shiftKey||(n.preventDefault(),E())}),h.addEventListener("input",function(){h.style.height="auto",h.style.height=Math.min(h.scrollHeight,120)+"px"})}),"loading"===document.readyState);else{const n=new Event("DOMContentLoaded");document.dispatchEvent(n)}}();